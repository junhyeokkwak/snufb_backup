<!DOCTYPE html>
<html>
<head>
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta charset="utf-8">
  <title>사용자 등록</title>
  <link rel="stylesheet" type="text/css" href="style.css">
</head>
<body onLoad="initInput()">
  <script>
    window.fbAsyncInit = function() {
       FB.init({
         appId      : '2169355909963830',
         xfbml      : true,
         version    : 'v2.11'
       });
       FB.AppEvents.logPageView();
     };
    var user_psid;
   (function(d, s, id){
     var js, fjs = d.getElementsByTagName(s)[0];
     if (d.getElementById(id)) {return;}
     js = d.createElement(s); js.id = id;
     js.src = "https://connect.facebook.com/en_US/messenger.Extensions.js";
     fjs.parentNode.insertBefore(js, fjs);
   }(document, 'script', 'Messenger'));
   window.extAsyncInit = function () {
       var isSupported = MessengerExtensions.isInExtension();
       MessengerExtensions.getContext('2169355909963830',
         function success(result){
           user_psid = result.psid;
           initInput(user_psid);
           console.log("Success: "+ result.psid);
         },
         function error(result){
           swal("ERR CODE: " + JSON.stringify(result), "미안! 등록 사이트에 문제가 생겼나봐 ㅠㅠ\n 혹시 컴퓨터로 접속했니?", "error")
           console.log("FAIL: " + JSON.stringify(result));
         }
       );
     };
   function endNewRegi() {
     var regiMajor = document.forms[0].newRegiMajor.value;
     var regiClass = document.forms[0].newRegiClass.value;
     alert("[전공: " + regiMajor + " / 학번: " + regiClass + "] 사용자 정보가 등록됐어!\n창은 [확인]을 누르면 꺼질거야!\n 혹시 잘못 입력한 정보가 있니?");
     closeWindow();
   }

   function closeWindow() {
     MessengerExtensions.requestCloseBrowser(function success() {
         console.log("closing success");
     }, function error(err) {
         console.log("closing failure");
         console.log(err);
     });
    window.open('','_self',''); window.close(); // _parent
   }

   function initInput(user_psid) {
    	document.forms[0].user_psid.value = user_psid;
   }

   function sendAjax(url, data){
     // 입력값을 변수에 담고 문자열 형태로 변환
     var data = {'data' : data};
     data = JSON.stringify(data);
     // content-type을 설정하고 데이터 송신
     var xhr = new XMLHttpRequest();
     xhr.open('POST', url);
     xhr.setRequestHeader('Content-type', "application/json");
     xhr.send(data);
     // 데이터 수신이 완료되면 표시
     xhr.addEventListener('load', function(){
       console.log(xhr.responseText);
     });
   }

  </script>

  <script src="https://unpkg.com/sweetalert/dist/sweetalert.min.js"></script>
  <div class = "login-page">
    <div class = "form" herf="#" href="#">
      <form class = "register-form" id = "register-form" method="post"/>
      <input name="user_psid" type="hidden" value="" />
      <input name = "newRegiMajor" type="text" placeholder="전공학과"/>
      <input name = "newRegiClass" type="text" placeholder="학번"/>
      <button class = "submit" id="btn-submit-new" value = "submit"> 등록 </button>
      </form>

    </div>
  </div>

  <script src="https://code.jquery.com/jquery-3.3.1.min.js"></script>
  <script>
    $('.message a').click(function(){
    $('form').animate({height: "toggle", opacity: "toggle"}, "slow")
    });
    $(document).on('click', '#btn-submit-new', function(e) {
      data
      var regiMajor = document.forms[0].newRegiMajor.value;
      var regiClass = document.forms[0].newRegiClass.value;
      e.preventDefault();
      swal({
        title: "정보 확인",
        text: "[전공: " + regiMajor + " / 학번: " + regiClass + "] 사용자 정보가 등록됐어!\n창은 [확인]을 누르면 꺼질거야!\n 혹시 잘못 입력한 정보가 있니?",
        icon: "success",
        className: 'sweetalert-lg',
        buttons: {
          cancel: {
            text: "다시 입력",
            value: false,
            visible: true,
            className: "",
            closeModal: true,
          },
          confirm: {
            text: "확인",
            value: true,
            visible: true,
            className: "",
            closeModal: true
          }
        },
      }).then((value) => {
        if (!value) {
          swal({
            title: '다시 입력해줘!',
            text: '',
            icon: "error",
            className: 'sweetalert-lg',
          });
        } else {
          // document.getElementById("register-form").submit();
          swal({
            title: '등록 완료',
            text: '등록이 완료됐어!',
            icon: "success",
            className: 'sweetalert-lg',
            buttons: {
              confirm: {
                text: "확인",
                value: true,
                visible: true,
                className: "",
                closeModal: true
              }
            }
          }).then((value) => {
            console.log(value);
            if (!value) {
              alert("!value");
              // var messageData = {
              //   "regiMajor" : document.forms[0].newRegiMajor.value,
              //   "regiClass" : document.forms[0].newRegiClass.value,
              // }
              // messageData = JSON.stringify(messageData)
              // sendAjax(window.location.href, messageData);
              closeWindow();
              document.getElementById("register-form").submit();
            } else {
              alert("value")
              // var messageData = {
              //   "regiMajor" : document.forms[0].newRegiMajor.value,
              //   "regiClass" : document.forms[0].newRegiClass.value,
              // }
              // messageData = JSON.stringify(messageData)
              // sendAjax(window.location.href, messageData);
              // closeWindow();
              document.getElementById("register-form").submit();
              closeWindow();
            }
          });
        }
      });
    });
  </script>
</body>
</html>
