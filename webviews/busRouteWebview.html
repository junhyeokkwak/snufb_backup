<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0, user-scalable=no">
    <title>간단한 지도 표시하기</title>
    <script type="text/javascript" src="https://openapi.map.naver.com/openapi/v3/maps.js?clientId=mSdY16Cdgy3tfbILEmSN&callback=initMap"></script>
    <script type="text/javascript" src="busRouteWebview.js"></script>
</head>
<body>
  <script src="https://unpkg.com/sweetalert/dist/sweetalert.min.js"></script>
  <!-- NOTE: messengerSDK module : temporary closed -->
  <!-- <script>
    window.fbAsyncInit = function() {
       FB.init({
         appId      : '2169355909963830',
         xfbml      : true,
         version    : 'v2.11'
       });
       FB.AppEvents.logPageView();
     };
    var user_psid;
   (function(d, s, id){
     var js, fjs = d.getElementsByTagName(s)[0];
     if (d.getElementById(id)) {return;}
     js = d.createElement(s); js.id = id;
     js.src = "https://connect.facebook.com/en_US/messenger.Extensions.js";
     fjs.parentNode.insertBefore(js, fjs);
   }(document, 'script', 'Messenger'));

   window.extAsyncInit = function () {
       var isSupported = MessengerExtensions.isInExtension();
       MessengerExtensions.getContext('2169355909963830',
         function success(result){
           user_psid = result.psid;
           initInput(user_psid);
           console.log("Success: "+ result.psid);
         },
         function error(result){
           swal("ERR CODE: " + JSON.stringify(result), "미안! 등록 사이트에 문제가 생겼나봐 ㅠㅠ\n 혹시 컴퓨터로 접속했니?", "error")
           console.log("FAIL: " + JSON.stringify(result));
         }
       );
     };

   function closeWindow() {
     MessengerExtensions.requestCloseBrowser(function success() {
         console.log("closing success");
     }, function error(err) {
         console.log("closing failure");
         console.log(err);
     });
    window.open('','_self',''); window.close(); // _parent
   }
   module.exports.closeWindow = closeWindow;

   function initInput(user_psid) {
     alert(user_psid);
   }
  </script> -->

  <button type="button" onclick="createMarker()">Change Content</button>
  <div id="map" style="width:100%;height:400px;"></div>
<script>
  window.onload = function() {
    loadData();
    //set map center
  }

  var mapOptions = {
      center: new naver.maps.LatLng(37.5540291075, 126.9348325761),
      zoom: 10
  };
  var map = new naver.maps.Map('map', mapOptions);

  var createMarker = function(){
    var marker = new naver.maps.Marker({
      position: new naver.maps.LatLng(37.5540291075, 126.9348325761),
      map: map
    });
  }


  // document.getElementById('ajaxsend').addEventListener('click', function(){
  //   var inputdata = document.forms[0].elements[0].value;
  //   sendAjax('/busRoute/send_result', inputdata)
  // });

  function loadData() {
    var xhttp = new XMLHttpRequest();
    xhttp.onreadystatechange = function() {
      if (this.readyState == 4 && this.status == 200) {
        // document.getElementById("getPositionData").innerHTML =
        // this.responseText;
        // alert(this.responseText);
        // alert(this.responseText.length)
        sendAjax('/busRoute/send_result', this.responseText);
        sendAjax('/busRoute/send_result', JSON.parse(this.responseText).length);
        if (JSON.parse(this.responseText).length > 1) {
          //need to transform responseText into JSON obj in arr
          handleMultipleSt(JSON.parse(this.responseText));
        }
      }
    };
    xhttp.open("GET", "/busRoute/positiondata", true);
    xhttp.send();
  }

  var handleMultipleSt = function(positionData) {
    sendAjax('/busRoute/send_result', "RUN handleMultipleSt");
    sendAjax('/busRoute/send_result', "handleMultipleSt " + JSON.stringify(positionData) + " length: " + positionData.length);
    // for(var i = 0; i < positionData.length; i++) {
    //   sendAjax('/busRoute/send_result', `xpos: ${positionData[i].xpos} ypos: ${positionData[i].ypos}`);
    //   generateMarker(i, positionData[i].xpos, positionData[i].ypos);
    // }
    positionData.forEach(item => {
      sendAjax('/busRoute/send_result', `xpos: ${item.xpos} ypos: ${item.ypos}`);
      generateMarker(i, item.xpos, item.ypos);
    })
  }

  var generateMarker = function(num, xpos, ypos){
    sendAjax('/busRoute/send_result', "RUN generateMarker");
    // if (typeof xpos != number) xpos = pareseInt(xpos);
    // if (typeof ypos != number) ypos = pareseInt(ypos);
    eval(`var marker${num} = ${
      new naver.maps.Marker({
        // position: new naver.maps.LatLng(ypos, xpos),
        position: new naver.maps.LatLng(xpos, ypos),
        map: map
      })
    };`);
  }


  function sendAjax(url, data){
    // 입력값을 변수에 담고 문자열 형태로 변환
    var data = {'email' : data};
    data = JSON.stringify(data);
    // content-type을 설정하고 데이터 송신
    var xhr = new XMLHttpRequest();
    xhr.open('POST', url);
    xhr.setRequestHeader('Content-type', "application/json");
    xhr.send(data);
    // 데이터 수신이 완료되면 표시
    xhr.addEventListener('load', function(){
      console.log(xhr.responseText);
    });
  }


</script>

</body>
</html>
